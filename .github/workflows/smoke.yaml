name: Smoke tests

on:
  push:
    branches:
    - test/smoke

env:
  CI: true
  REDOCLY_TELEMETRY: off

jobs:
  # smoke:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #         cache: 'npm'
  #     - name: Install dependencies
  #       run: npm ci

  #     - name: Install Yarn
  #       run: npm i -g yarn@^1.22.19

  #     - name: Prepare Smoke
  #       run: bash ./scripts/prepare-smoke.sh

  #     - name: Switch Node 18
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #         cache: 'npm'
  #     - run: bash ./scripts/run-smoke.sh "npm i redocly-cli.tgz"
  #     - run: bash ./scripts/run-smoke.sh "npm i redoc redocly-cli.tgz"
     
  #     - name: Switch Node 16
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version: 16
  #         cache: 'npm'
  #     - run: bash ./scripts/run-smoke.sh "npm i redocly-cli.tgz"
  #     - run: bash ./scripts/run-smoke.sh "npm i redoc redocly-cli.tgz"
    

  #     - name: Switch Node 14
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version: 14
  #         cache: 'npm'
  #     - run: bash ./scripts/run-smoke.sh "npm i redocly-cli.tgz"
  #     - run: bash ./scripts/run-smoke.sh "npm i redoc redocly-cli.tgz"

  #     - name: Switch Node 12
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version: 12
  #         cache: 'npm'
  #     - run: bash ./scripts/run-smoke.sh "npm i redocly-cli.tgz"
  #     - run: bash ./scripts/run-smoke.sh "npm i redoc redocly-cli.tgz"


  # smoke-yarn:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #         cache: 'npm'
  #     - name: Install dependencies
  #       run: npm ci
     
  #     - name: Install Yarn
  #       run: npm i -g yarn@^1.22.19

  #     - name: Prepare Smoke
  #       run: bash ./scripts/prepare-smoke.sh

  #     - run: bash ./scripts/run-smoke.sh "yarn add ./openapi-core.tgz ./redocly-cli-clean.tgz"
  #     - run: bash ./scripts/run-smoke.sh "yarn add redoc ./openapi-core.tgz ./redocly-cli-clean.tgz"


  prepare-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'
      - name: Install dependencies
        run: npm ci

      - name: Prepare Smoke
        run: bash ./scripts/prepare-smoke.sh

      - uses: actions/cache@v3
        with:
          path: __tests__/smoke/
          key: cache-${{ github.run_id }}-${{ github.run_attempt }}

  run-smoke:
    needs: prepare-smoke
    runs-on: ubuntu-latest
    steps:
      # - uses: actions/checkout@v3


      - name: ECHOOOOOOOO1111111
        run: |
          echo "Current directory:"
          pwd
          echo
          echo "Current directory content:"
          ls -a
          echo
          echo "Target directory content:"
          ls -a __tests__/smoke/
          echo




      - uses: actions/cache@v3
        with:
          path: __tests__/smoke/
          key: cache-${{ github.run_id }}-${{ github.run_attempt }}

      - name: ECHOOOOOOOO2222222
        run: |
          echo "Current directory:"
          pwd
          echo
          echo "Current directory content:"
          ls -a
          echo
          echo "Target directory content:"
          ls -a __tests__/smoke/
          echo


      - uses: actions/setup-node@v3
        with:
          node-version: 18
          # cache: 'npm'

      # - name: Install Yarn # Not needed, already installed with setup-node?
      #   run: npm i -g yarn@^1.22.19
    


      - name: Run Smoke
        run: bash ./scripts/run-smoke.sh "npm i redocly-cli.tgz"
