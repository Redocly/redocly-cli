name: Smoke tests

on:
  push:
    branches:
    - chore/smoke-tests

env:
  CI: true
  REDOCLY_TELEMETRY: off

jobs:
  prepare-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'
      - name: Install dependencies
        run: npm ci

      - name: Prepare Smoke
        run: bash ./scripts/prepare-smoke.sh

      - uses: actions/cache@v3
        with:
          path: __tests__/smoke/
          key: cache-${{ github.run_id }}-${{ github.run_attempt }}

  run-smoke--npm--node-18:
    needs: prepare-smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/cache@v3
        with:
          path: __tests__/smoke/
          key: cache-${{ github.run_id }}-${{ github.run_attempt }}

      - uses: actions/setup-node@v3
        with:
          node-version: 18

      - run: bash ./__tests__/smoke/run-smoke.sh "npm i redocly-cli.tgz"

  run-smoke--npm--node-18--redoc:
    needs: prepare-smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/cache@v3
        with:
          path: __tests__/smoke/
          key: cache-${{ github.run_id }}-${{ github.run_attempt }}

      - uses: actions/setup-node@v3
        with:
          node-version: 18

      - run: bash ./__tests__/smoke/run-smoke.sh "npm i redoc redocly-cli.tgz"

  run-smoke--webpack--node-18:
    needs: prepare-smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/cache@v3
        with:
          path: __tests__/smoke/
          key: cache-${{ github.run_id }}-${{ github.run_attempt }}

      - uses: actions/setup-node@v3
        with:
          node-version: 18

      - run: | # bash ./__tests__/smoke/run-smoke.sh 'alias redocly="node bundle.js"'
          file_content=`cat ./__tests__/smoke/package.json`
          echo "$file_content"
          output="${file_content//redocly /node bundle.js }"
          # output="${$(cat ./__tests__/smoke/package.json)//redocly /node bundle.js }"
          echo "$output" 
          echo "$output" > ./__tests__/smoke/package.json
          
          bash ./__tests__/smoke/run-smoke.sh "echo Test Webpack"



          # echo
          # echo "Running smoke test for command: $1"
          # echo "NPM version: $(npm -v)"
          # echo "Yarn version: $(yarn --version)"
          # echo 

          # cd __tests__/smoke

          # echo "Directory content:"
          # ls -a
          # echo

          # # Executing the command provided as the first argument 
          # $1

          # # Actual smoke test
          # node bundle.js v
          # node bundle.js l
          # node bundle.js b
          # node bundle.js d
          # # Check for broken styles (related issue: https://github.com/Redocly/redocly-cli/issues/1073)
          # if [[ "$(wc -l redoc-static.html)" == "317 redoc-static.html" ]]; then
          #   echo "Docs built correctly."
          # else
          #   echo "Docs built incorrectly. Received lines: $(wc -l redoc-static.html) (expected 317 lines in redoc-static.html)."
          #   exit 1
          # fi


  run-smoke--npm--node-16:
    needs: prepare-smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/cache@v3
        with:
          path: __tests__/smoke/
          key: cache-${{ github.run_id }}-${{ github.run_attempt }}

      - uses: actions/setup-node@v3
        with:
          node-version: 16

      - run: bash ./__tests__/smoke/run-smoke.sh "npm i redocly-cli.tgz"

  run-smoke--npm--node-16--redoc:
    needs: prepare-smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/cache@v3
        with:
          path: __tests__/smoke/
          key: cache-${{ github.run_id }}-${{ github.run_attempt }}

      - uses: actions/setup-node@v3
        with:
          node-version: 16

      - run: bash ./__tests__/smoke/run-smoke.sh "npm i redoc redocly-cli.tgz"

  run-smoke--npm--node-14:
    needs: prepare-smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/cache@v3
        with:
          path: __tests__/smoke/
          key: cache-${{ github.run_id }}-${{ github.run_attempt }}

      - uses: actions/setup-node@v3
        with:
          node-version: 14
          
      - run: bash ./__tests__/smoke/run-smoke.sh "npm i redocly-cli.tgz"


  run-smoke--npm--node-14--redoc:
    needs: prepare-smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/cache@v3
        with:
          path: __tests__/smoke/
          key: cache-${{ github.run_id }}-${{ github.run_attempt }}

      - uses: actions/setup-node@v3
        with:
          node-version: 14

      - run: bash ./__tests__/smoke/run-smoke.sh "npm i redoc redocly-cli.tgz"

  run-smoke--npm--node-12:
    needs: prepare-smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/cache@v3
        with:
          path: __tests__/smoke/
          key: cache-${{ github.run_id }}-${{ github.run_attempt }}

      - uses: actions/setup-node@v3
        with:
          node-version: 12

      - run: bash ./__tests__/smoke/run-smoke.sh "npm i redocly-cli.tgz"

  run-smoke--npm--node-12--redoc:
    needs: prepare-smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/cache@v3
        with:
          path: __tests__/smoke/
          key: cache-${{ github.run_id }}-${{ github.run_attempt }}

      - uses: actions/setup-node@v3
        with:
          node-version: 12

      - run: bash ./__tests__/smoke/run-smoke.sh "npm i redoc redocly-cli.tgz"

  run-smoke--yarn--node-18:
    needs: prepare-smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/cache@v3
        with:
          path: __tests__/smoke/
          key: cache-${{ github.run_id }}-${{ github.run_attempt }}

      - uses: actions/setup-node@v3
        with:
          node-version: 18

      # - name: Install Yarn # Not needed, already installed with setup-node?
      #   run: npm i -g yarn@^1.22.19
    


      - run: bash ./__tests__/smoke/run-smoke.sh "yarn add ./openapi-core.tgz ./redocly-cli-clean.tgz"
      

  run-smoke--yarn--node-18--redoc:
    needs: prepare-smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/cache@v3
        with:
          path: __tests__/smoke/
          key: cache-${{ github.run_id }}-${{ github.run_attempt }}

      - uses: actions/setup-node@v3
        with:
          node-version: 18

      # - name: Install Yarn # Not needed, already installed with setup-node?
      #   run: npm i -g yarn@^1.22.19
    
      - run: bash ./__tests__/smoke/run-smoke.sh "yarn add redoc ./openapi-core.tgz ./redocly-cli-clean.tgz"

