name: Major Version Release Guard

permissions:
  contents: read
  pull-requests: read

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    branches:
      - main

jobs:
  check-major-version:
    name: Confirm major version release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect major version changeset
        id: detect
        run: |
          MAJOR_FILES=$(grep -rl ': major$' .changeset/ --include="*.md" 2>/dev/null || true)
          if [ -n "$MAJOR_FILES" ]; then
            echo "has_major=true" >> "$GITHUB_OUTPUT"
            echo "Major version bump found in:"
            echo "$MAJOR_FILES"
          else
            echo "has_major=false" >> "$GITHUB_OUTPUT"
            echo "No major version bump detected."
          fi

      - name: Require cli-main-version-release label
        if: steps.detect.outputs.has_major == 'true'
        run: |
          HAS_LABEL=$(gh pr view ${{ github.event.pull_request.number }} \
            --json labels \
            --jq '[.labels[].name] | contains(["cli-main-version-release"])')
          if [ "$HAS_LABEL" = "true" ]; then
            echo "✅ Label 'cli-main-version-release' is present. Major release approved."
          else
            echo "❌ A major version bump was detected in the changesets, but the"
            echo "   'cli-main-version-release' label is missing from this PR."
            echo "   Add the label to confirm this is an intentional major release."
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
