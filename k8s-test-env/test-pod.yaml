apiVersion: v1
kind: Pod
metadata:
  name: redocly-cli-test-pod
  namespace: redocly-cli-test
  labels:
    app: redocly-cli-test-pod
spec:
  containers:
    - name: redocly-cli
      image: node:20-alpine
      command: ['/bin/sh']
      args:
        - -c
        - |
          # Install iptables to block network access
          # apk add --no-cache iptables

          # Copy test files
          cp /config/large-api.yaml /workspace/open-api-v1.json
          cp /config/redocly.yaml /workspace/
          cd /workspace

          echo "=== Redocly CLI Test Environment ==="
          echo "Local packages available in /workspace:"
          ls -la /workspace/*.tgz
          echo ""
          echo "Test files available:"
          ls -la /workspace/
          echo ""
          echo "Ready for manual testing. Use: kubectl exec -it redocly-cli-test-pod -n redocly-cli-test -- sh"

          # Keep container running for manual access
          tail -f /dev/null
      volumeMounts:
        - name: config-volume
          mountPath: /config
        - name: workspace-volume
          mountPath: /workspace
      env:
        - name: NODE_ENV
          value: 'test'
        - name: CI
          value: 'true'
        - name: REDOCLY_OFFLINE
          value: 'false'
      securityContext:
        capabilities:
          add:
            - NET_ADMIN
            - NET_RAW
  volumes:
    - name: config-volume
      configMap:
        name: redocly-test-config
    - name: workspace-volume
      emptyDir: {}
  restartPolicy: Never
